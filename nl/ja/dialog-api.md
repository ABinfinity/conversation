---

copyright:
  years: 2015, 2017
lastupdated: "2017-09-21"

---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:tip: .tip}
{:pre: .pre}
{:codeblock: .codeblock}
{:screen: .screen}
{:javascript: .ph data-hd-programlang='javascript'}
{:java: .ph data-hd-programlang='java'}
{:python: .ph data-hd-programlang='python'}
{:swift: .ph data-hd-programlang='swift'}

# API を使用したダイアログの変更

{{site.data.keyword.conversationshort}} REST API は、{{site.data.keyword.conversationshort}} ツールを使用せずにダイアログをプログラムで変更することをサポートします。/dialog_nodes API を使用して、ダイアログ・ノードを作成、削除、変更することができます。

ダイアログは相互接続ノードのツリーであるということ、有効であるためには特定のルールに従う必要があるということに注意してください。つまり、あるダイアログ・ノードに何らかの変更を加えると、他のノードやダイアログの構造に連鎖的に影響する可能性があります。/dialog_nodes API を使用してダイアログを変更する前に、変更がダイアログの残りの部分にどのように影響するかを理解しておく必要があります。

有効なダイアログは必ず以下の基準を満たしています。

- ダイアログ・ノードごとに固有 ID があります (`dialog_node` プロパティー)。
- 下位ノードはその親ノードを認識しています (`parent` プロパティー)。一方、親ノードはその子を認識していません。
- ノードは、その直前の兄弟が存在すればそれを認識しています (`previous_sibling` プロパティー)。これは、ある特定の親のすべての兄弟がリンク・リストを形成し、各ノードは直前のノードを指していることを意味します。
- ある特定の親の 1 つの子だけが最初の兄弟になることができます (つまり、その `previous_sibling` はヌル)。
- ノードは、異なる親の子である直前の兄弟を指すことはできません。
- 直前の同じ兄弟を 2 つのノードが指すことはできません。
- ノードは、次に実行される別のノードを指定できます (`next_step` プロパティー)。
- ノードは、自身の親にも自身の兄弟にもなれません。
- `response_condition` タイプのノードに子を設定することはできません。

以下の例は、さまざまな変更が加えられることによって連鎖的に変化が起こる場合に、それがどのように生じるかを示しています。

## ノードの作成
{: #create-node}

次のシンプルなダイアログ・ツリーを考えてみます。

![ダイアログ例](images/dialog_api_1.png)

次の本体を含む POST 要求を /dialog_nodes に行うことによって、新しいノードを作成できます。

```json
{
  "dialog_node": "node_8"
}
```

ダイアログは次のようになります。

![ダイアログ例 2](images/dialog_api_2.png)

**node_8** は、`parent` の値も `previous_sibling` の値も指定せずに作成されたので、ダイアログ内の最初のノードになりました。**node_8** を作成することに加えて、サービスは **node_1** も変更して、その `previous_sibling` プロパティーがこの新しいノードを指すようにします。

次のように親と直前の兄弟を指定することにより、ダイアログ内の他の場所にノードを作成できます。

```json
{
  "dialog_node": "node_9",
  "parent": "node_2",
  "previous_sibling": "node_5"
}
```

`parent` と `previous_node` に指定する各値は、次のとおり有効でなければなりません。

- 両方の値とも既存のノードを参照していなければなりません。
- 指定した親は、直前の兄弟の親と同じでなければなりません (直前の兄弟に親がない場合は `null`)。
- `response_condition` タイプのノードを親にすることはできません。

結果のダイアログは次のようになります。

![ダイアログ例 3](images/dialog_api_3.png)

**node_9** を作成することに加えて、サービスは *node_6* の `previous_sibling` プロパティーを自動的に更新して、新しいノードを指すようにします。

## 異なる親へのノードの移動
{: #change-parent}

次の本体を含む POST /dialog_nodes/node_5 メソッドを使用して、**node_5** を異なる親に移動しましょう。

```json
{
  "parent": "node_1"
}
```

`parent` に指定する値は、次のとおり有効でなければなりません。
- 既存のノードを参照していなければなりません。
- 変更されるノードを参照していてはなりません (ノードを自身の親にすることはできません)。
- 変更されるノードの子孫を参照していてはなりません。
- `response_condition` タイプのノードを参照していてはなりません。

この結果、次のような構造に変わります。

![ダイアログ例 4](images/dialog_api_4.png)

ここで、次のようないくつかのことが起こりました。
- **node_5** がその親に移動したとき、**node_7** もそれと一緒に移動しました (**node_7** の `parent` 値が変わらなかったため)。ノードを移動すると、そのノードのすべての子孫はそのノードに付き添います。
- **node_5** の `previous_sibling` 値を指定しなかったので、このノードが **node_1** の下の最初の兄弟になりました。
- **node_4** の `previous_sibling` プロパティーが `node_5` に更新されました。
- **node_9** の `previous_sibling` プロパティーが `null` に更新されました (このノードが **node_2** の下の最初の兄弟になったため)。

## 兄弟の並べ直し
{: #change-sibling}

ここで、**node_5** を最初の兄弟ではなく 2 番目の兄弟にしましょう。この操作は、次の本体を含む POST /dialog_nodes/node_5 メソッドを使用して行えます。

```json
{
  "previous_sibling": "node_4"
}
```

`previous_sibling` を変更する場合、新しい値は次のとおり有効でなければなりません。
- 既存のノードを参照していなければなりません。
- 変更されるノードを参照していてはなりません (ノードを自身の兄弟にすることはできません)。
- 同じ親の子を参照していなければなりません (すべての兄弟に同じ親がなければなりません)。

次のように構造が変わります。

![ダイアログ例 5](images/dialog_api_5.png)

繰り返しますが、**node_7** はその親に付き添います。また、**node_4** が変更されてその `previous_sibling` が `null` になります (このノードが最初の兄弟になったため)。

## ノードの削除
{: #delete-node}

今度は、DELETE /dialog_nodes/node_1 メソッドを使用して、**node_1** を削除しましょう。

結果は次のようになります。

![ダイアログ例 6](images/dialog_api_6.png)

**node_1**、**node_4**、**node_5**、**node_7** がすべて削除されたことに注意してください。ノードを削除すると、そのノードのすべての子孫も削除されます。従って、基本ノードを削除すると、実際はダイアログ・ツリーの枝全体を削除することになります。削除されたノードへの他の参照 (`next_step` 参照など) はすべて、`null` に変更されます。

さらに、**node_2** が更新されて、その新しい直前の兄弟として **node_8** を指すようになります。

## ノードの名前変更
{: #rename-node}

最後に、次の本体を含む POST /dialog_nodes/node_2 メソッドを使用して、**node_2** の名前を変更しましょう。

```json
{
  "dialog_node": "node_X"
}
```

![ダイアログ例 7](images/dialog_api_7.png)

ダイアログの構造は変わっていませんが、また次の複数のノードが変更されて、変更された名前が反映されています。

- **node_9** と **node_6** の `parent` プロパティー
- **node_3** の `previous_sibling` プロパティー

削除されたノードへの他の参照 (`next_step` 参照など) もすべて変更されます。
